<script>
  // ...same Firebase init & variables as you already have...

  await db.runTransaction(async tx => {
    const keySnap = await tx.get(keyRef);
    if (!keySnap.exists) { outcome = 'no-key'; return; }
    const data = keySnap.data();      // { cardId, claimedBy?, claimedAt? }
    cardId = data.cardId;
    if (!cardId) { outcome = 'bad-key'; return; }

    // If someone else already claimed this key
    if (data.claimedBy && data.claimedBy !== uid) {
      outcome = 'claimed-by-other';
      return;
    }

    // Always read user
    const userSnap = await tx.get(userRef);
    const cards = (userSnap.exists && Array.isArray(userSnap.data().cards))
                  ? userSnap.data().cards : [];
    const alreadyHave = cards.includes(cardId);

    if (data.claimedBy === uid) {
      // Key is yours already → ensure the card is in your array
      if (!alreadyHave) {
        tx.set(userRef, {
          username: (user.email||'').split('@')[0] || 'user',
          cards: firebase.firestore.FieldValue.arrayUnion(cardId)
        }, { merge: true });
        outcome = 'owned-again-added';   // previously missing, now fixed
      } else {
        outcome = 'owned-again';
      }
      return;
    }

    // First time ever → claim key + add card
    if (alreadyHave) {
      // You somehow already have the card; don't consume this key
      outcome = 'already-have';
      return;
    }

    tx.update(keyRef, {
      claimedBy: uid,
      claimedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    tx.set(userRef, {
      username: (user.email||'').split('@')[0] || 'user',
      cards: firebase.firestore.FieldValue.arrayUnion(cardId)
    }, { merge: true });

    outcome = 'owned-new';
  });

  // Messages (add one case)
  if (outcome === 'owned-new') {
    msg(`🎉 Claimed! You are the <b>OWNER</b> of <b>${cardId}</b>.`);
    sub("Redirecting to your collection…");
  } else if (outcome === 'owned-again-added') {
    msg(`✅ You already owned the key. We added <b>${cardId}</b> to your collection.`);
    sub("Opening your collection…");
  } else if (outcome === 'owned-again') {
    msg(`✅ You already own <b>${cardId}</b> (same key).`);
    sub("Opening your collection…");
  } else if (outcome === 'already-have') {
    msg(`✅ You already have <b>${cardId}</b>.`);
    sub("This key stays unused so someone else can redeem it.");
  } else if (outcome === 'claimed-by-other') {
    msg(`⚠️ This key was already claimed by someone else.`);
    sub("Ask them to share it with you.");
  } else if (outcome === 'no-key') {
    msg("❌ Key not found.");
  } else {
    msg("❌ Invalid key.");
  }
  setTimeout(() => location.href = 'card.html', 1400);
</script>
