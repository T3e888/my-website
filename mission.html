<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Stroke Hero - Daily Quiz</title>
  <style>
    body { margin:0; font-family:Arial,sans-serif; background:#fff; color:#333; }
    .container { display:flex; min-height:100vh; }
    .sidebar { width:200px; background:#d32f2f; display:flex; flex-direction:column; justify-content:space-between; }
    .sidebar h2, .sidebar .username { color:#fff; text-align:center; margin:20px 0 10px; }
    .sidebar ul { list-style:none; padding:0; margin:0; flex-grow:1; }
    .sidebar li { border-top:1px solid #c62828; }
    .sidebar li:first-child { border-top:none; }
    .sidebar li a { display:block; color:#fff; text-decoration:none; padding:12px 16px; }
    .sidebar li:hover { background:#c62828; }
    .sidebar li.active { background:#b71c1c; }
    .sidebar li.active a { font-weight:bold; }
    .sidebar .bottom a { display:block; text-align:center; padding:12px 16px; color:#fff; text-decoration:none; border-top:1px solid #c62828; }
    .sidebar .bottom a:hover { background:#c62828; }
    .content { flex:1; padding:20px; }
    .options { margin:15px 0; }
    .option-btn { display:block; width:100%; max-width:300px; margin:5px 0; padding:10px; font-size:16px; }
    .option-btn.correct { background:#c8e6c9; }
    .option-btn.wrong { background:#ffcdd2; }
    .option-btn:disabled { opacity:0.6; }
    .popup { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; }
    .popup-content { background:#fff; padding:20px; border:2px solid #d32f2f; border-radius:8px; text-align:center; width:300px; max-width:80%; }
    .popup-content h3 { color:#d32f2f; margin-top:0; }
    .popup-content img { max-width:100%; height:auto; display:block; margin:10px auto; }
    .popup-content p { font-weight:bold; }
    .popup-content button { margin-top:10px; padding:8px 16px; background:#d32f2f; color:#fff; border:none; border-radius:4px; cursor:pointer; }
    .popup-content button:hover { background:#b71c1c; }

    /* Hamburger Menu */
    .menu-toggle {
      display:none; position:fixed; top:12px; left:12px;
      font-size:24px; background:#d32f2f; color:#fff;
      border:none; padding:6px 12px; z-index:1001;
      border-radius:4px; cursor:pointer;
    }
    @media(max-width:768px){
      .menu-toggle{display:block;}
      .sidebar{position:fixed;top:0;left:-220px;width:200px;height:100%;background:#d32f2f;transition:left .3s ease;z-index:1000;padding-top:60px;}
      .sidebar.open{left:0;}
      .content{margin-left:0!important;width:100%;padding:16px;}
    }
  </style>
  <script>
    if(!localStorage.getItem('token')) window.location.href='login.html?redirect=mission.html';
  </script>
</head>
<body>
  <button class="menu-toggle" onclick="toggleSidebar()">☰</button>
  <div class="container">
    <div class="sidebar">
      <h2>Stroke Hero</h2>
      <div class="username">User: <span id="usernameDisplay"></span></div>
      <ul class="menu">
        <li><a href="index.html">List Card</a></li>
        <li><a href="scan.html">Scan QR</a></li>
        <li class="active"><a href="mission.html">Mission</a></li>
        <li><a href="change.html">Change Card</a></li>
      </ul>
      <div class="bottom">
        <a href="#" id="logoutLink">LOG OUT</a>
      </div>
    </div>
    <div class="content">
      <h1>Daily Quiz</h1>
      <div id="quiz-section">
        <p id="question-text"></p>
        <div class="options" id="optionsContainer"></div>
        <div id="resultMsg" style="display:none;font-weight:bold;margin-top:10px;"></div>
      </div>
      <div id="wait-section" style="display:none;">
        <p id="waitMsg"></p>
      </div>
    </div>
  </div>

  <div id="cardPopup" class="popup">
    <div class="popup-content">
      <h3>New Card Unlocked!</h3>
      <img id="popupCardImg" src="" alt="Card" />
      <p id="popupCardName"></p>
      <button id="popupClose">Close</button>
    </div>
  </div>

  <script>
    function toggleSidebar(){document.querySelector('.sidebar').classList.toggle('open');}
    const user=localStorage.getItem('token');
    document.getElementById('usernameDisplay').textContent=user||'';
    const userCardsKey=user+'_cards';
    let unlocked=JSON.parse(localStorage.getItem(userCardsKey)||'{}');
    const allCards=['card1','card2'];
    const quizData={question:"F ใน FAST ย่อมาจากอะไร?",options:["Finger","Face","Foot","Food"],answerIndex:1};
    const lastTimeKey=user+'_lastQuizTime',lastStatusKey=user+'_lastQuizStatus';
    const lastTime=localStorage.getItem(lastTimeKey),lastStatus=localStorage.getItem(lastStatusKey);
    const lockedList=allCards.filter(c=>!unlocked[c]||unlocked[c]===0);
    if(lockedList.length===0){
      document.getElementById('quiz-section').style.display='none';
      document.getElementById('wait-section').style.display='block';
      document.getElementById('waitMsg').innerText="คุณสะสมครบแล้ว!";
    } else if(lastTime){
      const diff=Date.now()-parseInt(lastTime);
      if(diff<24*60*60*1e3){
        document.getElementById('quiz-section').style.display='none';
        document.getElementById('wait-section').style.display='block';
        document.getElementById('waitMsg').innerText= lastStatus==='correct'
          ?"ทำแบบทดสอบแล้ว โปรดกลับมาใหม่พรุ่งนี้."
          :"ตอบผิดวันนี้ ลองใหม่หลัง 24 ชม.";
      }
    }
    document.getElementById('question-text').textContent=quizData.question;
    const opts=document.getElementById('optionsContainer');opts.innerHTML='';
    quizData.options.forEach((opt,i)=>{
      const b=document.createElement('button');b.className='option-btn';b.textContent=opt;b.dataset.idx=i;
      b.onclick=()=>{
        document.querySelectorAll('.option-btn').forEach(x=>x.disabled=true);
        if(i===quizData.answerIndex){
          b.classList.add('correct');
          localStorage.setItem(lastTimeKey,Date.now().toString());
          localStorage.setItem(lastStatusKey,'correct');
          const locked=allCards.filter(c=>!unlocked[c]||unlocked[c]===0);
          if(locked.length){
            const newC=locked[Math.floor(Math.random()*locked.length)];
            unlocked[newC]=1;localStorage.setItem(userCardsKey,JSON.stringify(unlocked));
            document.getElementById('popupCardImg').src=`assets/cards/${newC}.png`;
            document.getElementById('popupCardName').innerText=newC;
            document.getElementById('cardPopup').style.display='flex';
          }
        } else {
          b.classList.add('wrong');
          document.querySelectorAll('.option-btn').forEach(x=>{
            if(parseInt(x.dataset.idx)===quizData.answerIndex)x.classList.add('correct');
          });
          const msg=document.getElementById('resultMsg');msg.style.display='block';msg.style.color='red';
          msg.innerText="ตอบไม่ถูก ต้องรอ 24 ชม.";
          localStorage.setItem(lastTimeKey,Date.now().toString());
          localStorage.setItem(lastStatusKey,'wrong');
        }
      };
      opts.appendChild(b);
    });
    document.getElementById('logoutLink').onclick=()=>{localStorage.removeItem('token');location='login.html';};
    document.getElementById('popupClose').onclick=()=>{document.getElementById('cardPopup').style.display='none';};
  </script>
</body>
</html>
