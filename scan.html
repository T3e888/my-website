<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Stroke Hero - Scan QR</title>
  <style>
    body { margin:0; font-family:Arial,sans-serif; background:#fff; color:#333; }
    .container { display:flex; min-height:100vh; }
    .sidebar { width:200px; background:#d32f2f; display:flex; flex-direction:column; justify-content:space-between; }
    .sidebar h2, .sidebar .username { color:#fff; text-align:center; margin:20px 0 10px; }
    .sidebar ul { list-style:none; padding:0; margin:0; flex-grow:1; }
    .sidebar li { border-top:1px solid #c62828; }
    .sidebar li:first-child { border-top:none; }
    .sidebar li a { display:block; color:#fff; text-decoration:none; padding:12px 16px; }
    .sidebar li:hover { background:#c62828; }
    .sidebar li.active { background:#b71c1c; }
    .sidebar li.active a { font-weight:bold; }
    .sidebar .bottom a { display:block; text-align:center; padding:12px 16px; color:#fff; text-decoration:none; border-top:1px solid #c62828; }
    .sidebar .bottom a:hover { background:#c62828; }
    .content { flex:1; padding:20px; }
    #video { margin:10px 0; max-width:100%; }
    .popup { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; }
    .popup-content { background:#fff; padding:20px; border:2px solid #d32f2f; border-radius:8px; text-align:center; width:300px; max-width:80%; }
    .popup-content h3 { color:#d32f2f; margin-top:0; }
    .popup-content img { max-width:100%; height:auto; display:block; margin:10px auto; }
    .popup-content p { font-weight:bold; }
    .popup-content button { margin-top:10px; padding:8px 16px; background:#d32f2f; color:#fff; border:none; border-radius:4px; cursor:pointer; }
    .popup-content button:hover { background:#b71c1c; }

    /* Hamburger Menu */
    .menu-toggle {
      display:none; position:fixed; top:12px; left:12px;
      font-size:24px; background:#d32f2f; color:#fff;
      border:none; padding:6px 12px; z-index:1001;
      border-radius:4px; cursor:pointer;
    }
    @media(max-width:768px){
      .menu-toggle{display:block;}
      .sidebar{position:fixed;top:0;left:-220px;width:200px;height:100%;background:#d32f2f;transition:left .3s ease;z-index:1000;padding-top:60px;}
      .sidebar.open{left:0;}
      .content{margin-left:0!important;width:100%;padding:16px;}
    }
  </style>
  <script>
    if(!localStorage.getItem('token')){
      window.location.href='login.html?redirect=scan.html';
    }
  </script>
</head>
<body>
  <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
  <div class="container">
    <div class="sidebar">
      <h2>Stroke Hero</h2>
      <div class="username">User: <span id="usernameDisplay"></span></div>
      <ul class="menu">
        <li><a href="index.html">List Card</a></li>
        <li class="active"><a href="scan.html">Scan QR</a></li>
        <li><a href="mission.html">Mission</a></li>
        <li><a href="change.html">Change Card</a></li>
      </ul>
      <div class="bottom">
        <a href="#" id="logoutLink">LOG OUT</a>
      </div>
    </div>
    <div class="content">
      <h1>Scan QR Code</h1>
      <p>‡∏™‡πÅ‡∏Å‡∏ô QR ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î: ‡πÉ‡∏´‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û QR</p>
      <button id="cameraBtn">üì∑ Use Camera</button>
      <button id="stopBtn" style="display:none;">Stop Camera</button>
      <input type="file" id="fileInput" accept="image/*" />
      <br/>
      <video id="video" autoplay playsinline style="display:none;"></video>
    </div>
  </div>

  <div id="cardPopup" class="popup">
    <div class="popup-content">
      <h3 id="popupTitle">New Card Unlocked!</h3>
      <img id="popupCardImg" src="" alt="Card" />
      <p id="popupCardName"></p>
      <button id="popupClose">Close</button>
    </div>
  </div>

  <script>
    // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏û‡∏±‡∏ö‡πÑ‡∏î‡πâ
    function toggleSidebar() {
      document.querySelector('.sidebar').classList.toggle('open');
    }

    // ‚úÖ QR ‡∏à‡∏≤‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå
    const params = new URLSearchParams(window.location.search);
    const qrCardId = params.get('card');
    if (qrCardId) handleQRCode(qrCardId);

    const currentUser = localStorage.getItem('token');
    document.getElementById('usernameDisplay').textContent = currentUser || '';
    const userCardsKey = currentUser + '_cards';
    let unlocked = JSON.parse(localStorage.getItem(userCardsKey) || '{}');
    const allCards = ['card1', 'card2']; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ

    const video = document.getElementById('video');
    const cameraBtn = document.getElementById('cameraBtn');
    const stopBtn = document.getElementById('stopBtn');
    let stream = null, scanInterval = null, detector = null;

    cameraBtn.addEventListener('click', async () => {
      if (!('BarcodeDetector' in window)) { alert('Browser not supported'); return; }
      detector = new BarcodeDetector({ formats: ['qr_code'] });
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      } catch (e) { alert('Cannot access camera'); return; }
      video.srcObject = stream;
      video.style.display = 'block';
      stopBtn.style.display = 'inline-block';
      cameraBtn.style.display = 'none';

      const canvas = document.createElement('canvas'), ctx = canvas.getContext('2d');
      scanInterval = setInterval(async () => {
